# transforms
transform lo:
    xcenter 0.5
    ycenter 0.5
    zoom 2
transform con:
    xcenter 0.3
    ycenter 0.85
    zoom 1
transform on:
    xcenter 0.84
    ycenter 0.39
transform ti:
    xpos 0.016
    ypos 0.04
transform text:
    xcenter 0.5
    ycenter 0.5
transform on2:
    xcenter 0.845
    ycenter 0.405
transform go:
    xcenter 0.926
    ycenter 0.685
    zoom 1.7
transform girl:
    xcenter 0.84
    ycenter 0.39
    zoom 0.725


# screens
screen time:
    vbox:
        xpos 0.016
        ypos 0.04
        imagebutton idle "images/time.png" action ShowMenu("preferences")


# images
image logo2:
    "images/logo/logo1.png"
    0.04
    "images/logo/logo2.png"
    0.04
    "images/logo/logo3.png"
    0.04
    "images/logo/logo4.png"
    0.04
    "images/logo/logo5.png"
    0.04
    "images/logo/logo6.png"
    0.04
    "images/logo/logo7.png"
    0.04
    "images/logo/logo8.png"
    0.04
    "images/logo/logo9.png"
    0.04
    "images/logo/logo10.png"
    0.04
    "images/logo/logo11.png"
    0.04
    "images/logo/logo12.png"
    0.04
    "images/logo/logo13.png"
    0.04
    "images/logo/logo14.png"
    0.04
    "images/logo/logo15.png"
    0.04
    "images/logo/logo16.png"
    0.04
    "images/logo/logo17.png"
    0.04
    "images/logo/logo18.png"
    0.04
    "images/logo/logo19.png"
    0.04
    "images/logo/logo20.png"
    0.04
    "images/logo/logo21.png"
    0.04
    "images/logo/logo22.png"
    0.04
    "images/logo/logo23.png"
    0.04
    "images/logo/logo24.png"
    0.04
    "images/logo/logo25.png"
    0.04
    "images/logo/logo26.png"
    0.04
    "images/logo/logo27.png"
    0.04
    "images/logo/logo28.png"
    0.04
    "images/logo/logo29.png"
    0.04
    "images/logo/logo30.png"
    0.04
    "images/logo/logo31.png"
    0.04
    "images/logo/logo32.png"
    0.04
    "images/logo/logo33.png"
    0.04
    "images/logo/logo34.png"
    0.04
    "images/logo/logo35.png"
    0.04
    "images/logo/logo36.png"
    0.04
    "images/logo/logo37.png"
    0.04
    "images/logo/logo38.png"
    0.04
    "images/logo/logo39.png"
    0.04
image hito_kotoba:
        xpos 0.63
        ypos 0.488
        "images/anime/output2/01.png"
        0.04
        "images/anime/output2/02.png"
        0.04
        "images/anime/output2/03.png"
        0.04
        "images/anime/output2/04.png"
        0.04
        "images/anime/output2/05.png"
        0.04
        "images/anime/output2/06.png"
        0.04
        "images/anime/output2/07.png"
        0.04
        "images/anime/output2/08.png"
        0.04
        "images/anime/output2/09.png"
        0.04
        "images/anime/output2/10.png"
        0.04
        "images/anime/output2/11.png"
        0.04
        "images/anime/output2/12.png"
        0.04
        "images/anime/output2/13.png"
        0.04
        "images/anime/output2/14.png"
        0.04
        "images/anime/output2/15.png"
        0.04
        "images/anime/output2/16.png"
        0.04
        "images/anime/output2/17.png"
        0.04
        "images/anime/output2/18.png"
        0.04
        "images/anime/output2/19.png"
        0.04
        "images/anime/output2/20.png"
        0.04
        "images/anime/output2/21.png"
        0.04
        "images/anime/output2/22.png"
        0.04
        "images/anime/output2/23.png"
        0.04
        "images/anime/output2/24.png"
        0.04
        "images/anime/output2/25.png"
        0.04
        "images/anime/output2/26.png"
        0.04
        "images/anime/output2/27.png"
        0.04
        "images/anime/output2/28.png"
        0.04
        "images/anime/output2/29.png"
        0.04
        "images/anime/output2/30.png"
        0.04
        "images/anime/output2/31.png"
        0.04
        "images/anime/output2/32.png"
        0.04
        "images/anime/output2/33.png"
        0.04
        "images/anime/output2/34.png"
        0.04
        "images/anime/output2/35.png"
        0.04
        "images/anime/output2/36.png"
        0.04
        "images/anime/output2/37.png"
        0.04
        "images/anime/output2/38.png"
        0.04
        "images/anime/output2/39.png"
        0.04
        "images/anime/output2/40.png"
        0.04
        "images/anime/output2/41.png"
        0.04
        "images/anime/output2/42.png"
        0.04
        "images/anime/output2/43.png"
        0.04
        "images/anime/output2/44.png"
        0.04
        "images/anime/output2/45.png"
        0.04
        "images/anime/output2/46.png"
        0.04
        "images/anime/output2/47.png"
        0.04
        "images/anime/output2/48.png"
        0.04
        "images/anime/output2/49.png"
        0.04
        "images/anime/output2/50.png"
        0.04
        "images/anime/output2/51.png"
        0.04
        "images/anime/output2/52.png"
        0.04
        "images/anime/output2/53.png"
        0.04
        "images/anime/output2/54.png"
        0.04
        "images/anime/output2/55.png"
        0.04
        "images/anime/output2/56.png"
        0.04
        "images/anime/output2/57.png"
        0.04
        "images/anime/output2/58.png"
        0.04
        "images/anime/output2/59.png"
        0.04
        "images/anime/output2/60.png"
        0.04
        repeat
image hito_kotoba2:
        "images/anime/output2/01.png"
        0.04
        "images/anime/output2/02.png"
        0.04
        "images/anime/output2/03.png"
        0.04
        "images/anime/output2/04.png"
        0.04
        "images/anime/output2/05.png"
        0.04
        "images/anime/output2/06.png"
        0.04
        "images/anime/output2/07.png"
        0.04
        "images/anime/output2/08.png"
        0.04
        "images/anime/output2/09.png"
        0.04
        "images/anime/output2/10.png"
        0.04
        "images/anime/output2/11.png"
        0.04
        "images/anime/output2/12.png"
        0.04
        "images/anime/output2/13.png"
        0.04
        "images/anime/output2/14.png"
        0.04
        "images/anime/output2/15.png"
        0.04
        "images/anime/output2/16.png"
        0.04
        "images/anime/output2/17.png"
        0.04
        "images/anime/output2/18.png"
        0.04
        "images/anime/output2/19.png"
        0.04
        "images/anime/output2/20.png"
        0.04
        "images/anime/output2/21.png"
        0.04
        "images/anime/output2/22.png"
        0.04
        "images/anime/output2/23.png"
        0.04
        "images/anime/output2/24.png"
        0.04
        "images/anime/output2/25.png"
        0.04
        "images/anime/output2/26.png"
        0.04
        "images/anime/output2/27.png"
        0.04
        "images/anime/output2/28.png"
        0.04
        "images/anime/output2/29.png"
        0.04
        "images/anime/output2/30.png"
        0.04
        "images/anime/output2/31.png"
        0.04
        "images/anime/output2/32.png"
        0.04
        "images/anime/output2/33.png"
        0.04
        "images/anime/output2/34.png"
        0.04
        "images/anime/output2/35.png"
        0.04
        "images/anime/output2/36.png"
        0.04
        "images/anime/output2/37.png"
        0.04
        "images/anime/output2/38.png"
        0.04
        "images/anime/output2/39.png"
        0.04
        "images/anime/output2/40.png"
        0.04
        "images/anime/output2/41.png"
        0.04
        "images/anime/output2/42.png"
        0.04
        "images/anime/output2/43.png"
        0.04
        "images/anime/output2/44.png"
        0.04
        "images/anime/output2/45.png"
        0.04
        "images/anime/output2/46.png"
        0.04
        "images/anime/output2/47.png"
        0.04
        "images/anime/output2/48.png"
        0.04
        "images/anime/output2/49.png"
        0.04
        "images/anime/output2/50.png"
        0.04
        "images/anime/output2/51.png"
        0.04
        "images/anime/output2/52.png"
        0.04
        "images/anime/output2/53.png"
        0.04
        "images/anime/output2/54.png"
        0.04
        "images/anime/output2/55.png"
        0.04
        "images/anime/output2/56.png"
        0.04
        "images/anime/output2/57.png"
        0.04
        "images/anime/output2/58.png"
        0.04
        "images/anime/output2/59.png"
        0.04
        "images/anime/output2/60.png"
        0.04
        repeat
image BG01A = Image("images/BG01A.avif")
image BG13A1 = Image("images/BG13A1.avif")
image BG18A2 = Image("images/BG18A2.avif")
image BG05A1 = Image("images/BG05A1.avif")
image BG40N2 = Image("images/BG40N2.avif")
image loading = Image("images/loading.png")
image BG40A = Image("images/BG40A.avif")
image BG42A3 = Image("images/BG42A3.avif")
image BG91N = Image("images/BG91N.avif")
image BG99A = Image("images/BG99A.avif")
image BG101A = Image("images/BG101A.avif")
image phone1 = Image("images/phone1.png")
image phone2 = Image("images/phone2.png")

# functions
init -1 python:
    import re
    import uuid
    import json
    import requests


    class Chat(object):

        CHAT_VOICE = {
            "你好": ["hello.ogg","pleased_to_meet_you.ogg","what_do_you_want.ogg"],
            "hello": ["hello.ogg","what_do_you_want.ogg"],
            "hi": ["hello.ogg","what_do_you_want.ogg"],
            "变态": ["devilish_pervert.ogg","pervert_idot_wanttodie.ogg","perverts_go_to_hell.ogg","pervert_confirmed.ogg"],
            "下流": ["devilish_pervert.ogg","pervert_idot_wanttodie.ogg","perverts_go_to_hell.ogg","pervert_confirmed.ogg"],
            "禽兽": ["devilish_pervert.ogg","pervert_idot_wanttodie.ogg","perverts_go_to_hell.ogg","pervert_confirmed.ogg"],
            "事": ["ask_me_whatever.ogg","what_do_you_want.ogg","what_is_it.ogg"],
            "问题": ["ask_me_whatever.ogg","what_do_you_want.ogg","what_is_it.ogg"],
            "问": ["ask_me_whatever.ogg"],
            "克里斯": ["christina.ogg","should_christina.ogg","who_the_hell_christina.ogg","why_christina.ogg"],
            "提娜": ["dont_add_tina.ogg","should_christina.ogg","who_the_hell_christina.ogg","why_christina.ogg"],
            "娜": ["christina.ogg","should_christina.ogg","who_the_hell_christina.ogg","why_christina.ogg"],
            "chr": ["christina.ogg","should_christina.ogg","who_the_hell_christina.ogg","why_christina.ogg"],
            "助手": ["christina.ogg","should_christina.ogg","who_the_hell_christina.ogg","why_christina.ogg"],
            "帮助": ["could_i_help.ogg","what_do_you_want.ogg","what_is_it.ogg"],
            "帮忙": ["could_i_help.ogg","what_do_you_want.ogg","what_is_it.ogg"],
            "拒绝": ["daga_kotowaru.ogg","still_not_happy.ogg"],
            "做不到": ["daga_kotowaru.ogg","sorry.ogg","still_not_happy.ogg"],
            "不要": ["daga_kotowaru.ogg"],
            "zombie": ["dont_call_me_like_that.ogg"],
            "蒙古": ["dont_call_me_like_that.ogg"],
            "天才": ["dont_call_me_like_that.ogg"],
            "@cher": ["gah_extended.ogg"],
            "栗悟饭": ["dont_call_me_like_that.ogg"],
            "@ch": ["gah.ogg"],
            "有趣": ["heheh.ogg"],
            "开": ["heheh.ogg"],
            "哈": ["heheh.ogg"],
            "嘟": ["heheh.ogg"],
            "为": ["huh_why_say.ogg"],
            "why": ["huh_why_say.ogg"],
            "人": ["humans_software.ogg"],
            "是的": ["i_guess.ogg"],
            "这样": ["i_guess.ogg"],
            "总": ["i_guess.ogg"],
            "差": ["i_guess.ogg"],
            "以": ["i_guess.ogg"],
            "啊": ["i_see.ogg","you_sure.ogg"],
            "吗": ["i_see.ogg","you_sure.ogg"],
            "关": ["look_forward_to_working.ogg","pleased_to_meet_you.ogg","what_do_you_want.ogg"],
            "名": ["memories_christina.ogg"],
            "不同": ["memory_complex.ogg"],
            "不一样": ["memory_complex.ogg"],
            "不同": ["modifying_memories_impossible.ogg"],
            "很好": ["nice.ogg"],
            "ni": ["nice.ogg"],
            "冈部伦太郎": ["nice_to_meet_okabe.ogg","pleased_to_meet_you.ogg"],
            "红莉栖": ["nice_to_meet_okabe.ogg","pleased_to_meet_you.ogg"],
            "秘密": ["secret_diary.ogg"],
            "禁止": ["secret_diary.ogg"],
            "前辈": ["senpai_please_dont_tell.ogg","senpai_question.ogg","senpai_questionmark.ogg","senpai_what_we_talkin.ogg","senpai_who_is_this.ogg","uh_senpai.ogg","whats_so_funny_senpai.ogg"],
            "先辈": ["senpai_please_dont_tell.ogg","senpai_question.ogg","senpai_questionmark.ogg","senpai_what_we_talkin.ogg","senpai_who_is_this.ogg","uh_senpai.ogg","whats_so_funny_senpai.ogg"],
            "抱歉": ["sorry.ogg","still_not_happy.ogg"],
            "对不起": ["sorry.ogg","still_not_happy.ogg"],
            "sorry": ["sorry.ogg","still_not_happy.ogg"],
            "厉害": ["sounds_tough.ogg"],
            "de": ["sounds_tough.ogg"],
            "u": ["sounds_tough.ogg"],
            "ch": ["sounds_tough.ogg"],
            "ux": ["sounds_tough.ogg"],
            "windows": ["sounds_tough.ogg"],
            "py": ["sounds_tough.ogg"],
            "x": ["sounds_tough.ogg"],
            "arm": ["sounds_tough.ogg"],
            "mac": ["sounds_tough.ogg"],
            "an": ["sounds_tough.ogg"],
            "os": ["sounds_tough.ogg"],
            "un": ["sounds_tough.ogg"],
            "内核": ["sounds_tough.ogg"],
            "操作": ["sounds_tough.ogg"],
            "呢": ["sounds_tough.ogg"],
            "强": ["sounds_tough.ogg"],
            "受": ["this_guy_hopeless.ogg"],
            "办法": ["this_guy_hopeless.ogg"],
            "居然": ["this_guy_hopeless.ogg"],
            "没救了": ["this_guy_hopeless.ogg"],
            "无聊": ["this_guy_hopeless.ogg"],
            "意思": ["this_guy_hopeless.ogg"],
            "无趣": ["this_guy_hopeless.ogg"],
            "假": ["tm_nonsense.ogg"],
            "说": ["tm_nonsense.ogg"],
            "虚构": ["tm_nonsense.ogg"],
            "胡": ["tm_nonsense.ogg"],
            "不是": ["tm_nonsense.ogg"],
            "时间": ["tm_not_possible.ogg","tm_you_said.ogg"],
            "时光": ["tm_not_possible.ogg","tm_you_said.ogg"],
            "证": ["tm_scientist_no_evidence.ogg"],
            "据": ["tm_scientist_no_evidence.ogg"],
            "开": ["tm_scientist_no_evidence.ogg"],
            "维": ["tm_scientist_no_evidence.ogg"],
            "护": ["tm_scientist_no_evidence.ogg"],
            "明": ["tm_scientist_no_evidence.ogg"],
            "实": ["tm_scientist_no_evidence.ogg"],
            "依": ["tm_scientist_no_evidence.ogg"],
            "根": ["tm_scientist_no_evidence.ogg"],
            "太早": ["tm_too_early.ogg"],
            "提前": ["tm_too_early.ogg"],
            "未知": ["tm_we_dont_know.ogg"],
            "知道": ["tm_we_dont_know.ogg"],
            "是": ["what_is_it.ogg"],
            "什么": ["ok.ogg","sounds_tough.ogg"],
            "啊": ["ok.ogg","sounds_tough.ogg"],
            # 其他关键词和语音文件的映射
        }

        CHAT_IMAGE = {
            "变态": ["amadeus angry","amadeus sided_angry"],
            "下流": ["amadeus angry","amadeus sided_angry"],
            "畜生": ["amadeus angry","amadeus sided_angry"],
            "禽兽": ["amadeus angry","amadeus sided_angry"],
            "无聊": ["amadeus sided_eyes_closed","amadeus eyes_closed","amadeus annoyed","amadeus indifferent","amadeus pissed","amadeus side","amadeus sided_pleasant","amadeus sided_surprised","amadeus sided_thinking","amadeus sided_worried"],
            "没意思": ["amadeus sided_eyes_closed","amadeus eyes_closed","amadeus annoyed","amadeus indifferent","amadeus pissed","amadeus side","amadeus sided_pleasant","amadeus sided_surprised","amadeus sided_thinking","amadeus sided_worried"],
            "这样": ["amadeus sided_eyes_closed","amadeus eyes_closed","amadeus annoyed","amadeus indifferent","amadeus pissed","amadeus side","amadeus sided_pleasant","amadeus sided_surprised","amadeus sided_thinking","amadeus sided_worried"],
            "无趣": ["amadeus sided_eyes_closed","amadeus eyes_closed","amadeus annoyed","amadeus indifferent","amadeus pissed","amadeus side","amadeus sided_pleasant","amadeus sided_surprised","amadeus sided_thinking","amadeus sided_worried"],
            "真是": ["amadeus sided_eyes_closed","amadeus eyes_closed","amadeus annoyed","amadeus indifferent","amadeus pissed","amadeus side","amadeus sided_pleasant","amadeus sided_surprised","amadeus sided_thinking","amadeus sided_worried"],
            "没救": ["amadeus sided_eyes_closed","amadeus eyes_closed","amadeus annoyed","amadeus indifferent","amadeus pissed","amadeus side","amadeus sided_pleasant","amadeus sided_surprised","amadeus sided_thinking","amadeus sided_worried"],
            "克里斯": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "老婆": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "媳妇": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "爱": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "亲": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "女": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "美": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "可爱": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "帅": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "chri": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "@ch": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "栗悟饭": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "助手": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "zombie": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "蒙古斑": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "天才": ["amadeus blush","amadeus sided_blush","amadeus angry","amadeus sided_angry"],
            "可以": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "棒": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "厉害": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "强": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "是": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "天": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "好": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "哼": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "看": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "说": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "种": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "东": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "西": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "南": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "北": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "吃": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "喝": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "ubun": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "ux": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "un": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "os": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "id": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "win": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "mac": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "86": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "x": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "arm": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "/": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "c": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "命运石之门": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "鸣泣之时": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "不存在": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "十三": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "野": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "传说": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "17": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "kid": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "5pb": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "自": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "me": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "这样": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "哈": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "ga": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "st": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "el": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "@": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "嘟": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "咪": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "可": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "行": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            "安": ["amadeus happy","amadeus sided_pleasant","amadeus winking"],
            # 添加更多关键词和图像文件的映射
        }

        def __init__(self, msg=None):
            self.character = None
            self.current_vc = None
            self.msg = msg
            self.error = None
            self.conn = False
            self.waiting = False

        def init(self):
            self.waiting = True
            char_res = self.get_data('http://api.dfsteve.top/amadeus')
            if char_res:
                self.character = char_res.text
                self.conn = True
                renpy.notify("网络连接正常，单击继续......")
            else:
                renpy.notify("发生异常，单击继续......")
            self.waiting = False

        def chat(self, msg):
            renpy.notify("请求已发送，请稍后......")
            self.waiting = True

            headers = {
                "Content-Type": "application/json",
            }

            data = {
                "model": "gpt-3.5-turbo",
                "messages": msg
            }

            try:
                response = requests.post(persistent.api, headers=headers, data=json.dumps(data))
                message = response.json()["choices"][0]["message"]
                self.msg = message["content"]
                msg.append(message)
            except Exception as e:
                self.msg = False
                self.error = e
                renpy.notify("发生异常，单击继续......")
                self.waiting = False
                return
            
            self.waiting = False
            renpy.notify("接收到回复，单击继续......")

        def get_data(self, url, headers=None, timeout=10):
            try:
                response = requests.get(url, headers=headers, timeout=timeout)
            except Exception as e:
                self.error = e
                return False
            else:
                return response
        
        def get_ai_voice(self, text):
            renpy.notify("生成语音中......")
            self.waiting = True

            headers = {
                "Content-Type": "application/json"
            }

            myuuid = str(uuid.uuid4())
            data = {
                "text": text,
                "uuid": myuuid
            }

            try:
                requests.post("http://43.128.47.234:5001/tts", headers=headers, data=json.dumps(data))
                resp = requests.get(f"https://dfsteve.top/tts/{myuuid}.ogg")
            except Exception as e:
                self.error = e
                self.current_vc = None
                renpy.notify("发生异常，单击继续......")
                self.waiting = False
                return
            
            path = config.gamedir + f"\\audio\\ai_audio\\{myuuid}.ogg"
            path = re.sub(r'\\', "/", path)
            with open(path, "wb+") as f:
                f.write(resp.content)
            
            self.current_vc = path

            self.waiting = False
            renpy.notify("语音生成完成，请单击继续......")

        def get_chat_state(self, text, source):
            text = text.lower()
            for keyword, file in source.items():
                if keyword in text:
                    return renpy.random.choice(file)
        
        def parse_words(self, text):
            words = []
            # 判断是否有代码块  # TODO

            # 获取每句话
            res = re.findall(r'(.*?(。|\?|？|!|！|:|：|\.|——))', text)
            for r in res:
                words.append(r[0])
            # 获取最后一个标点后的所有字符
            p = re.compile(fr'{res[len(res)-1][0]}(.*)', flags=re.S)
            last_word = re.findall(p, text)[0]
            if last_word:
                words.append(last_word)

            return words